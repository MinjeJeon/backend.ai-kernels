FROM nvcr.io/nvidia/pytorch:18.12.1-py3

# Prepare for jail/hook minimal dependencies
RUN apt-get update && \
    apt-get install -y libseccomp2 libstdc++5 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/

# ipython/jupyter is already installed in the Anaconda Python installed at /opt/conda.

# Prepare runtime environment
ENV PYTHONUNBUFFERED=1 \
    PATH=/opt/backend.ai/bin:/opt/conda/bin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \
    LANG=C.UTF-8
WORKDIR /home/work
EXPOSE 2000 2001

LABEL ai.backend.envs.corecount="OPENBLAS_NUM_THREADS,OMP_NUM_THREADS,NPROC" \
      ai.backend.features="batch uid-match" \
      ai.backend.base-distro="ubuntu16.04" \
      ai.backend.service-ports="ipython:pty:3000,jupyter:http:8080"

COPY policy.yml /etc/backend.ai/jail/policy.yml
ENTRYPOINT []
CMD ["/opt/backend.ai/bin/entrypoint.sh", \
     "/opt/backend.ai/bin/jail", "-policy", "/etc/backend.ai/jail/policy.yml", \
     "/opt/backend.ai/bin/python", "-m", "ai.backend.kernel", "python", \
     "/opt/conda/bin/python"]

# vim: ft=dockerfile
